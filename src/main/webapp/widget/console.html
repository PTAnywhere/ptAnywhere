<!DOCTYPE html>
<html>
    <head lang="en">
        <meta charset="UTF-8">
        <title>Console</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font: 10pt Helvetica, Arial; }
            #messages { list-style-type: none; margin: 0; padding: 0; }
            #lastLine { float: left; margin-right: 4px; }
            #current { display: block; height: 100%; }
        </style>
        <script src="../../../widget/jquery/jquery.js"></script>
        <script>
             var ws = null;

            function setConnected(connected) {
                $('#current').prop( "disabled", !connected);
            }

            function tabToHtml(line) {
                var spacesBeginning = 0;
                for (var i=0; i<line.length; i++) {
                    if (line[i]==' ') {
                        spacesBeginning++;
                    } else break;
                }
                if (spacesBeginning==0) return line;
                return '<span style="margin-left: ' + spacesBeginning*5 + 'pt">' + line.substring(spacesBeginning) + '</span>';
            }

            function connect(target) {
                console.log('Connecting to websocket endpoint... (' + target + ')');

                if ('WebSocket' in window) {
                    ws = new WebSocket(target);
                } else if ('MozWebSocket' in window) {
                    ws = new MozWebSocket(target);
                } else {
                    alert('WebSocket is not supported by this browser.');
                    return;
                }
                ws.onopen = function () {
                    setConnected(true);
                    console.log('Info: WebSocket connection opened.');
                };
                ws.onmessage = function (event) {
                    var lines = event.data.split("\n");
                    if (lines.length>1) {
                        for (var i=0; i<lines.length-1; i++) { // Unnecessary
                            if (i==0) {
                                $("#messages").append($("#lastLine").text());
                                $("#lastLine").text('');
                            }
                            $("#messages").append( tabToHtml(lines[i]) + "<br />");
                        }
                    }
                    $("#lastLine").append(lines[lines.length-1]);
                    $("html, body").animate({ scrollTop: $(document).height() }, "slow");  // Scroll down
                };
                ws.onerror = function (event) {
                    setConnected(false);
                    console.log('Info: WebSocket error, Code: ' + event.code + (event.reason == "" ? "" : ", Reason: " + event.reason));
                };
                ws.onclose = function (event) {
                    setConnected(false);
                    console.log('Info: WebSocket connection closed, Code: ' + event.code + (event.reason == "" ? "" : ", Reason: " + event.reason));
                };
            }

            $(document).keypress(function(e) {
                if(e.which == 13) {
                    ws.send($("#current").text());
                    $("#current").text('');
                }
            });

            $(function() {
                connect( ('ws://'+ window.location.host + window.location.pathname).replace("api", "endpoint") );
            });
        </script>
    </head>
    <body>
        <div id="messages"></div>
        <div style="height: 8pt; width: 100%">
            <span id="lastLine"></span>
            <span id="current" contentEditable="true">ping 10.0.0.2</span>
        </div>
    </body>
</html>